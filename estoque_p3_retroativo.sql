
SELECT B6_EMISSAO, B6_CLIFOR,B6_LOJA, B6_PRODUTO,B6_QUANT, D2_LOTECTL, B6_IDENT FROM(
select
B6_EMISSAO
,B6_FILIAL
,B6_LOCAL
,sum(B6_QUANT * -1) B6_QUANT
,B6_PRODUTO
,B6_IDENT
, D2_NUMSERI
, B6_CLIFOR
, B6_LOJA
, D2_LOTECTL
FROM SB6010 SB6
LEFT JOIN SD2010 SD2 ON
( D2_FILIAL = B6_FILIAL AND D2_IDENTB6 = B6_IDENT AND B6_LOCAL = D2_LOCAL AND SD2.D_E_L_E_T_ <> '*' AND D2_DOC = B6_DOC )  	
WHERE SB6.D_E_L_E_T_ <> '*' AND B6_PODER3 = 'R'
--AND B6_EMISSAO >= '20211206'
group by B6_PRODUTO, B6_IDENT,B6_DOC,B6_FILIAL,B6_LOCAL,B6_EMISSAO,D2_NUMSERI, B6_CLIFOR, B6_LOJA, D2_LOTECTL

UNION ALL

select
B6_EMISSAO
,B6_FILIAL
,B6_LOCAL
,sum(B6_QUANT) quant
, B6_PRODUTO
, B6_IDENT
, D1_XSERIAL
, B6_CLIFOR
, B6_LOJA
, D1_LOTECTL
FROM SB6010 SB6
LEFT JOIN SD1010 SD1 ON
( D1_FILIAL = B6_FILIAL AND D1_IDENTB6 = B6_IDENT AND B6_LOCAL = D1_LOCAL AND SD1.D_E_L_E_T_ <> '*' AND D1_DOC = B6_DOC )  	
WHERE SB6.D_E_L_E_T_ <> '*' AND B6_PODER3 = 'D'
--AND B6_EMISSAO >= '20211206'
--AND D1_XSERIAL = '048600'
--AND B6_DOC = '000107098'
group by B6_PRODUTO, B6_IDENT,B6_DOC,B6_FILIAL,B6_LOCAL,B6_EMISSAO,D1_XSERIAL, B6_CLIFOR, B6_LOJA, B6_PRODUTO, D1_LOTECTL
) t
